---
title: "Latency to open door during familiarization"
author: "Liza Moscovice, Anja Eggert and Jean-Loup Rault"
date: "`r Sys.Date()`" 
editor: visual
code-fold: false
toc: true
format: html
---

# Libraries

```{r, libraries, warning=FALSE, message=FALSE, echo=TRUE}
library(tidyverse)     # tidy universe
library(emmeans)       # post-hoc
library(performance)   # model performance
library(viridis)       # colours
```

```{r, my_theme, echo = FALSE}
my_theme = theme_classic() +
  theme(axis.title = element_text(face="bold", size=14),
        axis.text  = element_text(size=12, angle = 0, vjust = 0.5),
        plot.title = element_text(face="bold", size=14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

```{r, seed}
set.seed(1989)
```

# Data

This data set contains data of 8 groups tested over 5 familiarization days. Each group consists of 7 to 10 pigs. The response is the latency for a door to be opened, which can only happen once per group per day, *i.e.* n = 40.

## Read data

```{r, data, warning = FALSE}
dat <- read_csv("../data/latency-familiarization.csv")
```

## Adjust data types

```{r, data-adj}
dat <- dat %>% 
  mutate_at(vars(familiarization_day,
                 unique.group), ~as.factor(.))
  
str(dat)
```

## Data summary

```{r, data-sum}
dat %>%
  group_by(familiarization_day) %>% 
  rstatix::get_summary_stats(lat.first.open.sec, 
                             type = "common")
```

# Linear model

We model repeated measures over 5 days to see an effect of training during familiarization.

## Run full model

```{r, model-full}
mod <- lm(sqrt(lat.first.open.sec) ~ 
            familiarization_day +
            unique.group,
            data   = dat)
```

## Run reduced model

```{r, model-reduced}
mod.red <-lm(sqrt(lat.first.open.sec) ~ 
            unique.group,
            data   = dat)
```

## Model comparison

```{r, model-comp}
anova(mod.red, mod, test="F")
```

## Summary of model

```{r, model-summary}
summary(mod)
```

-   with `car::Anova()` we calculate Deviance table and $F$ statistics, type II because of no interactions

```{r, model-table}
car::Anova(mod, type ="II", test.statistic = "F")
```

## Performance of model

-   `performance` package used to check model assumptions

```{r, model-perf, fig.height=10, fig.width=10, warning=FALSE}
performance::check_model(mod)
```

# Estimated Marginal Means and multiple comparisons

-   `emmeans` package to obtain the estimated marginal means (EMMs) for `familiarization_day`, as back-transformed estimates

```{r, emmeans}
emm <- emmeans(mod, 
               specs = pairwise ~ familiarization_day,
               type = "response",
               adjust = "tukey")

emm$emmeans

emm$contrasts
```

# Plot

## Compact letter display

```{r, cld}
cld <- multcomp::cld(emm$emmeans, Letters=letters) 
cld$.group <- str_replace_all(cld$.group, fixed(" "), "")
```

```{r, plot-1}
plot <- dat %>%
  ggplot() +
  geom_boxplot(aes(x = familiarization_day, 
                   y = lat.first.open.sec), 
               outlier.shape = NA, width = 0.5) +
  geom_jitter(aes(x = familiarization_day, 
                  y = lat.first.open.sec, 
                  col = unique.group), 
              size = 3, width = 0.15, alpha = 0.7) +
  scale_colour_viridis_d("Social group")+
  scale_y_continuous(lim = c(0, 85), breaks = seq(0, 85, 20)) +
  #scale_x_discrete(labels= xlabs) +
  geom_point(data=cld, col="black", size=3,
             aes(x=as.numeric(familiarization_day)+0.35, y=response)) +
  geom_errorbar(data=cld, col="black", width=0.1,
                aes(x=as.numeric(familiarization_day)+0.35,
                    ymin=response - SE, ymax=response + SE)) +
  geom_text(data=cld, col="black",
            aes(y=response, x=as.numeric(familiarization_day)+0.45, 
                label=.group, hjust = 0)) +
  labs(x = "Familiarization day",
       y = "Time to first open door (sec)") +
  my_theme +
  theme(legend.position = "none")
```

```{r, plot-2, fig.height=10, fig.width=10, warning=FALSE}
plot
```

# How to cite R

"All analyses were performed using R Statistical Software (version 4.2.0; R Core Team 2022)".

Reference: R Core Team (2022). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

```{r, cite-r}
citation()
version$version.string
```

```{r, cite-packages}
citation("tidyverse")
citation("nlme") 
citation("emmeans") 
citation("performance")
citation("viridis")
```

# Session Info

```{r, session}
sessionInfo()
```
